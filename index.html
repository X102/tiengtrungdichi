<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiếng Trung Dichi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px_12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 100%;
            max-width: 900px;
            overflow: hidden;
        }
        .text-content {
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            line-height: 2.8; /* Increased line-height for pinyin */
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 300px;
            max-height: 70vh;
            overflow-y: auto;
            font-size: 1.25rem;
        }
        .word-clickable, .segmented-word ruby {
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            display: inline-flex; 
            flex-direction: column-reverse;
            align-items: center;
            line-height: 1.2;
        }
        .word-clickable:hover, .segmented-word:hover {
            background-color: #e0e7ff; /* Light blue on hover */
        }
        .segmented-word {
            border: 1px solid #d1d5db;
            margin: 2px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.0);
            z-index: 999;
            display: none;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            position: absolute;
            max-width: 280px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            animation: fadeIn 0.2s ease-out;
            cursor: grab;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .button-base {
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }
        .button-base:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-base:hover:not(:disabled) {
             transform: translateY(-1px);
        }
        .button-base:active:not(:disabled) {
            transform: translateY(0);
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .button-secondary {
            background-color: #6b7280;
            color: white;
        }
        .button-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }
        .link-button {
            display: block;
            background-color: #eff6ff;
            color: #1d4ed8;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.9rem;
        }
        .link-button:hover {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        #ai-sentence-section, #ai-related-words-section, #explanation-section, #pinyin-text-section, #full-translation-section, #segmented-text-section, #reference-section, #text-stats-section {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
        }
        #google-translate-result, #selection-translate-result {
            margin-top: 10px;
            padding: 8px;
            background-color: #f0f4f8;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #333;
            border: 1px solid #d1e0ed;
        }
        .text-selection-popup {
            max-width: 320px; 
            padding: 10px;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: grab;
            position: absolute;
            z-index: 1001;
        }
        .text-selection-popup .button-secondary,
        .text-selection-popup .button-primary {
            padding: 6px 10px;
            font-size: 0.8rem;
            width: 100%;
        }
        .close-button {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            padding: 2px;
        }
        .close-button:hover {
            color: #374151;
        }
        .tts-controls {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background-color: #f9fafb;
        }
        #tts-progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            cursor: pointer;
            height: 10px;
        }
        #tts-progress-bar {
            height: 100%;
            background-color: #4f46e5;
            border-radius: 9999px;
            width: 0%;
            transition: width 0.1s linear;
        }
        #reference-section ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        #reference-section li {
            margin-bottom: 0.5rem;
        }
        #reference-section a {
            color: #3b82f6;
            text-decoration: underline;
        }
        #reference-section a:hover {
            color: #1d4ed8;
        }
        ruby rt {
            font-size: 110%;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-start mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Học tiếng Trung cùng Dichi</h1>
            <img src="kieuoanh.jpg" alt="<3" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover border-2 border-white shadow-lg flex-shrink-0">
        </div>

        <!-- Controls Section -->
        <div class="space-y-4 mb-4">
            <!-- Row 1: Data Input -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <!-- File Upload -->
                <div class="flex items-center space-x-2">
                    <label for="file-upload" class="button-base button-secondary cursor-pointer">Tải lên tệp tin .docx</label>
                    <input type="file" id="file-upload" class="hidden" accept=".txt,.docx">
                    <span id="file-name" class="text-gray-600 text-sm"></span>
                </div>
            </div>
            <!-- Row 2: Text Area Input -->
            <div class="mt-2">
                <label for="text-input-area" class="block mb-2 text-sm font-medium text-gray-700">Hoặc nhập văn bản trực tiếp:</label>
                <textarea id="text-input-area" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Dán hoặc gõ văn bản tiếng Trung của bạn vào đây..."></textarea>
                <button id="process-text-button" class="button-base button-primary mt-2">Xử lý văn bản</button>
            </div>
            <!-- Row 3: Tools -->
            <div class="flex flex-wrap items-center justify-center gap-4 pt-4">
                <button id="pinyin-button" class="button-base button-secondary">Thêm Pinyin</button>
                <button id="segment-text-button" class="button-base button-secondary">Tách cụm từ (AI)</button>
                <button id="explain-text-button" class="button-base button-secondary">Giải thích (AI)</button>
                <button id="translate-full-text-button" class="button-base button-secondary">Dịch toàn bộ văn bản</button>
            </div>
             <!-- Row 4: Text-to-Speech Controls -->
            <div class="tts-controls mt-4 space-y-3">
                <h3 class="text-lg font-medium text-center">Công cụ đọc thành tiếng</h3>
                <!-- Player Controls -->
                <div class="flex items-center gap-4">
                    <button id="tts-play-pause" class="button-base button-primary flex items-center justify-center w-28">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1zm6 0a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span id="play-pause-text" class="ml-2">Phát</span>
                    </button>
                    <button id="tts-stop" class="button-base button-secondary">Dừng</button>
                    <div id="tts-progress-container" class="flex-grow">
                        <div id="tts-progress-bar"></div>
                    </div>
                </div>
                <!-- Settings -->
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div class="flex items-center space-x-2">
                        <label for="tts-voice" class="text-sm font-medium">Giọng:</label>
                        <select id="tts-voice" class="p-2 border border-gray-300 rounded-md shadow-sm text-sm"></select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="tts-rate" class="text-sm font-medium">Tốc độ:</label>
                        <input type="range" id="tts-rate" min="0.5" max="2" value="1" step="0.1" class="w-24">
                        <span id="tts-rate-label" class="text-sm font-mono">1.0x</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="auto-play-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="auto-play-toggle" class="text-sm font-medium">Tự động phát âm</label>
                    </div>
                </div>
            </div>
        </div>
       
        <div id="main-text-section">
            <div class="section-header">
                <h3>Văn bản gốc</h3>
                <div>
                    <button id="copy-main-text-button" class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                    <button id="toggle-main-text-button" class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                </div>
            </div>
            <div id="text-display" class="text-content">
                <!-- Text content will be loaded here -->
                Vui lòng tải lên một tệp tin hoặc nhập văn bản để bắt đầu.
            </div>
        </div>


        <!-- Text Stats Section -->
        <div id="text-stats-section" class="hidden">
             <h3 class="text-xl font-semibold mb-3 text-gray-800">Thống kê văn bản</h3>
             <p class="text-sm text-gray-600">Độ dài văn bản: <span id="char-count" class="font-bold">0</span> ký tự</p>
             <p class="text-sm text-gray-600">Số đoạn (ước tính): <span id="word-count" class="font-bold">0</span> đoạn</p>
        </div>

        <!-- API Key Section -->
        <div id="api-key-section" class="mt-6 mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Cài đặt API Key</h4>
            <label for="api-key-input" class="block mb-1 text-sm font-medium text-gray-700">Nhập API Key của Google Gemini:</label>
            <div class="flex items-center gap-2">
                <input type="password" id="api-key-input" placeholder="Nhập API Key của bạn..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <button id="save-api-key-button" class="button-base button-primary">Lưu</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">API Key của bạn sẽ được lưu trữ cục bộ trên trình duyệt của bạn. Lấy API Key của bạn tại <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>.</p>
            <p id="api-key-status" class="text-sm text-green-600 mt-1 font-medium"></p>
        </div>

        <!-- AI Generation Section -->
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">Công cụ AI</h3>
            <div class="flex items-center gap-2">
                <input type="text" id="ai-custom-input" placeholder="Nhập từ hoặc cụm từ..." class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full">
            </div>
             <div class="flex items-center justify-center gap-2 mt-2">
                <button id="ai-generate-sentence-button" class="button-base button-primary">Tạo câu ví dụ</button>
                <button id="ai-generate-related-words-button" class="button-base button-primary">Tạo từ liên quan</button>
            </div>
             <div id="loading-spinner" class="loading-spinner"></div>
            <div id="ai-sentence-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden">
                <div class="section-header">
                    <h3>Câu ví dụ</h3>
                    <div>
                        <button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                        <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                    </div>
                </div>
                <div id="ai-sentence-content" class="section-content text-left"></div>
            </div>
             <div id="ai-related-words-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden">
                <div class="section-header">
                    <h3>Từ liên quan</h3>
                    <div>
                        <button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                        <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                    </div>
                </div>
                <div id="ai-related-words-content" class="section-content text-left"></div>
            </div>
        </div>

        <!-- Chunk Processing Controls -->
        <div id="chunk-processing-controls" class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-md hidden">
            <p id="chunk-status" class="text-sm text-yellow-800 mb-2"></p>
            <div class="flex items-center justify-center gap-2">
                <button id="process-pause-resume" class="button-base button-primary text-xs">Tạm dừng</button>
                <button id="process-stop" class="button-base button-secondary text-xs">Dừng</button>
            </div>
        </div>

        <!-- Pinyin Text Section -->
        <div id="pinyin-text-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Văn bản với Pinyin (AI)</h3>
                 <div>
                    <button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                    <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                </div>
            </div>
            <div id="pinyin-content" class="text-gray-700 text-content section-content"></div>
            <div id="pinyin-loading-spinner" class="loading-spinner"></div>
        </div>

        <!-- Segmented Text Section -->
        <div id="segmented-text-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Văn bản theo cụm từ (AI)</h3>
                 <div>
                    <button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                    <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                </div>
            </div>
            <div id="segmented-content" class="text-gray-700 text-content section-content" style="line-height: 2.5;"></div>
            <div id="segment-loading-spinner" class="loading-spinner"></div>
        </div>
       
        <!-- Full Translation Section -->
        <div id="full-translation-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Bản dịch (AI)</h3>
                 <div>
                    <button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                    <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                </div>
            </div>
            <div id="full-translation-content" class="text-gray-700 text-content section-content"></div>
            <div id="full-translation-loading-spinner" class="loading-spinner"></div>
        </div>

        <!-- AI Explanation Section -->
        <div id="explanation-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Giải thích nội dung văn bản (AI)</h3>
                 <div>
                    <button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2">Sao chép</button>
                    <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                </div>
            </div>
            <div id="explanation-content" class="text-gray-700 section-content"></div>
            <div id="explanation-loading-spinner" class="loading-spinner"></div>
        </div>

        <!-- Reference Section -->
        <div id="reference-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">Trang web tham khảo</h3>
            <ul>
                <li><a href="https://hanzii.net/" target="_blank">Hanzii.net</a> - Từ điển và công cụ học tiếng Trung toàn diện cho người Việt.</li>
                <li><a href="https://hvdic.thivien.net/" target="_blank">Từ điển Hán Nôm</a> - Tra cứu Hán tự, Nôm và các từ điển liên quan.</li>
                <li><a href="https://www.mdbg.net/chinese/dictionary" target="_blank">MDBG Chinese Dictionary</a> - Từ điển Trung-Anh trực tuyến miễn phí.</li>
                <li><a href="https://vtudien.com/trung-viet" target="_blank">Vtudien.com</a> - Từ điển đa ngôn ngữ.</li>
                <li>* Web này được tặng cho <a href="https://www.facebook.com/kieuoanhdichi" target="_blank">Kiều Oanh</a> - Giáo viên tiếng Trung, du học sinh thạc sĩ tại Trung Quốc.</li>
            </ul>
        </div>

        <!-- Word Lookup Modal -->
        <div id="lookup-modal" class="modal-overlay">
            <div id="modal-content-inner" class="modal-content">
                <button id="close-lookup-modal" class="close-button" title="Đóng">&times;</button>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Tra cứu từ: <span id="selected-word-modal" class="font-bold text-indigo-600"></span></h2>
                <div class="flex items-center gap-2 mt-2 mb-3">
                    <button id="pronounce-word-button" class="button-base button-primary flex-1">Phát âm</button>
                    <button id="copy-word-button" class="button-base button-secondary flex-1">Sao chép</button>
                </div>
                <div class="space-y-2">
                    <a id="hanzii-link" href="#" target="_blank" class="link-button">Tra từ điển Hanzii</a>
                    <a id="mdbg-link" href="#" target="_blank" class="link-button">Tra từ điển MDBG</a>
                    <a id="youglish-link" href="#" target="_blank" class="link-button">Tra YouGlish</a>
                    <a id="vtudien-link" href="#" target="_blank" class="link-button">Tra Vtudien</a>
                </div>
                <div id="google-translate-result" class="mt-4"></div>
                <div id="translate-loading-spinner" class="loading-spinner"></div>
            </div>
        </div>

        <!-- Text Selection Popup -->
        <div id="selection-popup" class="modal-content text-selection-popup hidden">
            <button id="close-selection-popup" class="close-button" title="Đóng">&times;</button>
            <div class="flex flex-col space-y-2">
                <button id="copy-selection-button" class="button-base button-secondary w-full">Sao chép</button>
                <button id="translate-selection-button" class="button-base button-primary w-full">Dịch</button>
                <button id="pronounce-selection-button" class="button-base button-primary w-full">Phát âm</button>
                <a id="hanzii-selection-link" href="#" target="_blank" class="link-button">Tra Hanzii</a>
            </div>
            <div id="selection-translate-result" class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-gray-700 text-sm hidden"></div>
            <div id="selection-translate-spinner" class="loading-spinner"></div>
        </div>
    </div>

    <!-- External libraries moved to the end of body -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
   
    <!-- Firebase SDK Compat libraries for global access -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Main App Logic -->
    <script>
        // --- Application Logic ---
        function mainApp() {
            // Global variables for Firebase (MANDATORY)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
   
            let auth;
            let db;
            let userId = null;
            let isAuthReady = false;
   
            // Initialize Firebase
            if (Object.keys(firebaseConfig).length > 0 && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
   
                // Listen for auth state changes
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await auth.signInWithCustomToken(initialAuthToken);
                            } else {
                                await auth.signInAnonymously();
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                        }
                    }
                    isAuthReady = true;
                });
            } else {
                console.warn("Firebase config not found or Firebase library not loaded. Firebase services will not be available.");
                isAuthReady = true;
                userId = crypto.randomUUID();
            }

            // --- DOM Element References ---
            const textDisplay = document.getElementById('text-display');
            const pinyinButton = document.getElementById('pinyin-button');
            const explainTextButton = document.getElementById('explain-text-button');
            const lookupModalOverlay = document.getElementById('lookup-modal');
            const modalContentInner = document.getElementById('modal-content-inner');
            const selectedWordModalSpan = document.getElementById('selected-word-modal');
            const hanziiLink = document.getElementById('hanzii-link');
            const mdbgLink = document.getElementById('mdbg-link');
            const youglishLink = document.getElementById('youglish-link');
            const vtudienLink = document.getElementById('vtudien-link');
            const googleTranslateResultDiv = document.getElementById('google-translate-result');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');
            const aiCustomInput = document.getElementById('ai-custom-input');
            const aiGenerateSentenceButton = document.getElementById('ai-generate-sentence-button');
            const aiGenerateRelatedWordsButton = document.getElementById('ai-generate-related-words-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const aiSentenceResultsSection = document.getElementById('ai-sentence-results-section');
            const aiRelatedWordsResultsSection = document.getElementById('ai-related-words-results-section');
            const aiSentenceContent = document.getElementById('ai-sentence-content');
            const aiRelatedWordsContent = document.getElementById('ai-related-words-content');
            const explanationSection = document.getElementById('explanation-section');
            const explanationContentDiv = document.getElementById('explanation-content');
            const explanationLoadingSpinner = document.getElementById('explanation-loading-spinner');
            const pinyinTextSection = document.getElementById('pinyin-text-section');
            const pinyinContentDiv = document.getElementById('pinyin-content');
            const pinyinLoadingSpinner = document.getElementById('pinyin-loading-spinner');
            const fullTranslationSection = document.getElementById('full-translation-section');
            const fullTranslationContent = document.getElementById('full-translation-content');
            const fullTranslationLoadingSpinner = document.getElementById('full-translation-loading-spinner');
            const translateFullTextButton = document.getElementById('translate-full-text-button');
            const segmentTextButton = document.getElementById('segment-text-button');
            const segmentedTextSection = document.getElementById('segmented-text-section');
            const segmentedContentDiv = document.getElementById('segmented-content');
            const segmentLoadingSpinner = document.getElementById('segment-loading-spinner');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');
            const selectionPopup = document.getElementById('selection-popup');
            const copySelectionButton = document.getElementById('copy-selection-button');
            const translateSelectionButton = document.getElementById('translate-selection-button');
            const selectionTranslateResultDiv = document.getElementById('selection-translate-result');
            const selectionTranslateSpinner = document.getElementById('selection-translate-spinner');
            const closeLookupModalBtn = document.getElementById('close-lookup-modal');
            const closeSelectionPopupBtn = document.getElementById('close-selection-popup');
            const textInputArea = document.getElementById('text-input-area');
            const processTextButton = document.getElementById('process-text-button');
            const textStatsSection = document.getElementById('text-stats-section');
            const charCountSpan = document.getElementById('char-count');
            const wordCountSpan = document.getElementById('word-count');
            const copyMainTextButton = document.getElementById('copy-main-text-button');
            const toggleMainTextButton = document.getElementById('toggle-main-text-button');
            const pronounceWordButton = document.getElementById('pronounce-word-button');
            const copyWordButton = document.getElementById('copy-word-button');
            const pronounceSelectionButton = document.getElementById('pronounce-selection-button');
            const hanziiSelectionLink = document.getElementById('hanzii-selection-link');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyButton = document.getElementById('save-api-key-button');
            const apiKeyStatus = document.getElementById('api-key-status');
           
            // TTS Controls
            const ttsPlayPauseBtn = document.getElementById('tts-play-pause');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playPauseText = document.getElementById('play-pause-text');
            const ttsStopBtn = document.getElementById('tts-stop');
            const ttsVoiceSelect = document.getElementById('tts-voice');
            const ttsRateSlider = document.getElementById('tts-rate');
            const ttsRateLabel = document.getElementById('tts-rate-label');
            const ttsProgressContainer = document.getElementById('tts-progress-container');
            const ttsProgressBar = document.getElementById('tts-progress-bar');
            const autoPlayToggle = document.getElementById('auto-play-toggle');
           
            // Chunk Processing Controls
            const chunkControls = document.getElementById('chunk-processing-controls');
            const chunkStatus = document.getElementById('chunk-status');
            const processPauseResumeBtn = document.getElementById('process-pause-resume');
            const processStopBtn = document.getElementById('process-stop');

            // --- State Variables ---
            let currentRawText = '';
            let justEndedDrag = false;
            let voices = [];
            let speechStartIndex = 0;
           
            // Chunk processing state
            let isProcessingChunks = false;
            let isPaused = false;
            let processingQueue = [];
            let currentChunkIndex = 0;
            let currentProcessFunction = null;
            let currentResultContainer = null;
            let currentLoadingSpinner = null;

            // --- Core Functions ---

            // Function to show non-blocking notifications
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '8px';
                notification.style.color = 'white';
                notification.style.backgroundColor = type === 'success' ? '#4f46e5' : '#dc2626'; // Indigo for success, red for error
                notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                notification.style.zIndex = '2000';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                notification.style.transform = 'translateX(-50%) translateY(20px)';


                document.body.appendChild(notification);

                // Fade in
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(-50%) translateY(0)';
                }, 10);

                // Fade out and remove
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) translateY(20px)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                           document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            function makeDraggable(element) {
                let isDragging = false;
                let initialMouseX, initialMouseY, initialElementLeft, initialElementTop;

                element.addEventListener("mousedown", dragStart);

                function dragStart(e) {
                    if (e.target.closest('a, button, .close-button')) return;
                    isDragging = true;
                    element.style.cursor = 'grabbing';
                    element.style.zIndex = 1001;
                    const rect = element.getBoundingClientRect();
                    initialElementLeft = rect.left;
                    initialElementTop = rect.top;
                    initialMouseX = e.clientX;
                    initialMouseY = e.clientY;
                    e.preventDefault();
                    e.stopPropagation();
                    justEndedDrag = false;
                }

                document.addEventListener("mousemove", (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        const dx = e.clientX - initialMouseX;
                        const dy = e.clientY - initialMouseY;
                        element.style.left = `${initialElementLeft + dx}px`;
                        element.style.top = `${initialElementTop + dy}px`;
                    }
                });

                document.addEventListener("mouseup", () => {
                    if (isDragging) {
                        isDragging = false;
                        element.style.cursor = 'grab';
                        element.style.zIndex = 1000;
                        justEndedDrag = true;
                        setTimeout(() => { justEndedDrag = false; }, 100);
                    }
                });
            }

            function addClickableSpansTo(element, text) {
                element.innerHTML = '';
                const parts = text.split(/([\u4e00-\u9fa5])/g); 
                parts.forEach(part => {
                    if (part.match(/[\u4e00-\u9fa5]/)) {
                        const span = document.createElement('span');
                        span.textContent = part;
                        span.className = 'word-clickable';
                        span.addEventListener('click', (event) => {
                            event.stopPropagation();
                            selectionPopup.classList.add('hidden');
                            openLookupModal(part, event);
                            aiCustomInput.value = part;
                            if(autoPlayToggle.checked) {
                                speakWord(part);
                            }
                        });
                        element.appendChild(span);
                    } else {
                        element.appendChild(document.createTextNode(part));
                    }
                });
            }

            function processNewContent(htmlContent, isHtml = false) {
                speechSynthesis.cancel();
                stopChunkProcessing();

                if (isHtml) {
                    textDisplay.innerHTML = htmlContent;
                    addClickableSpansTo(textDisplay, textDisplay.innerText);
                    currentRawText = textDisplay.innerText;
                } else {
                    currentRawText = htmlContent;
                    addClickableSpansTo(textDisplay, currentRawText);
                }

                // Update text stats
                charCountSpan.textContent = currentRawText.length;
                wordCountSpan.textContent = currentRawText.split(/[\s\n]+/).filter(Boolean).length;
                textStatsSection.classList.remove('hidden');


                [aiSentenceResultsSection, aiRelatedWordsResultsSection, explanationSection, pinyinTextSection, lookupModalOverlay, selectionPopup, fullTranslationSection, segmentedTextSection].forEach(el => el.classList.add('hidden'));
            }

            async function getTranslation(word, resultContainer) {
                translateLoadingSpinner.style.display = 'block';
                try {
                    const prompt = `Cho từ tiếng Trung "${word}", hãy cung cấp phiên âm pinyin và nghĩa tiếng Việt của nó. Trả về kết quả dưới dạng JSON với hai khóa: "pinyin" và "meaning".`;
                    const schema = { type: "OBJECT", properties: { "pinyin": { "type": "STRING" }, "meaning": { "type": "STRING" } }, required: ["pinyin", "meaning"] };
                    const jsonString = await callAI(prompt, "application/json", schema);
                    return JSON.parse(jsonString);
                } catch (error) {
                    console.error("Error calling AI for translation:", error);
                    if (resultContainer) {
                       resultContainer.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                    }
                    return { pinyin: 'Lỗi', meaning: `Không thể dịch.` };
                } finally {
                    translateLoadingSpinner.style.display = 'none';
                }
            }

            async function openLookupModal(word, event) {
                selectedWordModalSpan.textContent = word;
                const encodedWord = encodeURIComponent(word);
                hanziiLink.href = `https://hanzii.net/search/word/${encodedWord}?hl=vi`;
                mdbgLink.href = `https://www.mdbg.net/chinese/dictionary?page=worddict&wdrst=0&wdqb=${encodedWord}`;
                youglishLink.href = `https://youglish.com/pronounce/${encodedWord}/chinese`;
                vtudienLink.href = `https://vtudien.com/trung-viet/dictionary/nghia-cua-tu-${encodedWord}`;
                googleTranslateResultDiv.innerHTML = '';
                lookupModalOverlay.style.display = 'block';
                modalContentInner.style.visibility = 'hidden';
                const rect = event.target.getBoundingClientRect();
                const modalWidth = modalContentInner.offsetWidth;
                const modalHeight = modalContentInner.offsetHeight;
                const margin = 10;
                let top = rect.bottom + 5;
                let left = rect.left;
                if (left + modalWidth > window.innerWidth - margin) left = window.innerWidth - modalWidth - margin;
                if (left < margin) left = margin;
                if (top + modalHeight > window.innerHeight - margin) top = rect.top - modalHeight - 5;
                if (top < margin) top = margin;
                modalContentInner.style.left = `${left}px`;
                modalContentInner.style.top = `${top}px`;
                modalContentInner.style.visibility = 'visible';
               
                pronounceWordButton.onclick = () => speakWord(word);
                copyWordButton.onclick = () => copyToClipboard(word);

                const translationResult = await getTranslation(word, googleTranslateResultDiv);
                if (translationResult.meaning !== 'Không thể dịch.') {
                    googleTranslateResultDiv.innerHTML = `<strong>Dịch:</strong> ${translationResult.pinyin} - ${translationResult.meaning}`;
                }
            }

            makeDraggable(modalContentInner);
            makeDraggable(selectionPopup);

            document.addEventListener('mousedown', (event) => {
                if (justEndedDrag) return;

                const clickedInsideLookup = modalContentInner.contains(event.target);
                const clickedInsideSelection = selectionPopup.contains(event.target);
                const clickedOnWord = event.target.closest('.word-clickable, .segmented-word');

                if (lookupModalOverlay.style.display === 'block' && !clickedInsideLookup && !clickedOnWord) {
                    lookupModalOverlay.style.display = 'none';
                }
               
                if (!selectionPopup.classList.contains('hidden') && !clickedInsideSelection) {
                    const selection = window.getSelection();
                    if (selection.toString().length === 0) {
                        selectionPopup.classList.add('hidden');
                    }
                }
            });

            closeLookupModalBtn.addEventListener('click', () => {
                lookupModalOverlay.style.display = 'none';
            });

            closeSelectionPopupBtn.addEventListener('click', () => {
                selectionPopup.classList.add('hidden');
            });


            async function callAI(prompt, responseMimeType, responseSchema) {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    throw new Error("Vui lòng nhập API Key của bạn và nhấn Lưu để sử dụng các tính năng AI.");
                }
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType }
                };
                if (responseSchema) {
                    payload.generationConfig.responseSchema = responseSchema;
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Lỗi API: ${response.status} - ${await response.text()}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                }
                throw new Error("Cấu trúc phản hồi AI không mong muốn");
            }

            async function generateAiContent(button, input, section, contentDiv, promptGenerator, schema, contentRenderer) {
                const word = input.value.trim();
                if (!word) {
                    showNotification("Vui lòng nhập một từ hoặc cụm từ.", "error");
                    return;
                }
                loadingSpinner.style.display = 'block';
                section.classList.remove('hidden');
                contentDiv.innerHTML = '';
                button.disabled = true;
                try {
                    const prompt = promptGenerator(word);
                    const jsonString = await callAI(prompt, "application/json", schema);
                    const parsedJson = JSON.parse(jsonString);
                    contentRenderer(parsedJson, contentDiv);
                } catch (error) {
                    contentDiv.innerHTML = `<p class="text-red-600">Lỗi khi gọi AI: ${error.message}. Vui lòng thử lại.</p>`;
                    console.error("Error calling AI:", error);
                } finally {
                    loadingSpinner.style.display = 'none';
                    button.disabled = false;
                }
            }

            aiGenerateSentenceButton.addEventListener('click', () => {
                const promptGenerator = (word) => `Với từ tiếng Trung "${word}", hãy tạo một mảng JSON chứa 10 đối tượng. Mỗi đối tượng đại diện cho một câu ví dụ và phải có 3 thuộc tính: "sentence" (câu tiếng Trung), "pinyin" (phiên âm Pinyin của câu đó), và "meaning" (nghĩa tiếng Việt của câu đó).`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "sentence": { "type": "STRING" },
                            "pinyin": { "type": "STRING" },
                            "meaning": { "type": "STRING" }
                        },
                        "required": ["sentence", "pinyin", "meaning"]
                    }
                };
                const contentRenderer = (data, element) => {
                    const sentences = Array.isArray(data) ? data : [];
                    let htmlContent = '<ul class="list-disc list-inside space-y-2">';
                    if (sentences.length > 0) {
                        sentences.forEach(s => {
                            htmlContent += `<li>
                                <div class="font-semibold">${s.sentence}</div>
                                <div class="text-sm text-gray-500">${s.pinyin}</div>
                                <div class="text-sm text-blue-600">${s.meaning}</div>
                            </li>`;
                        });
                    } else {
                        htmlContent += '<li>Không có câu ví dụ nào được tạo.</li>';
                    }
                    htmlContent += '</ul>';
                    element.innerHTML = htmlContent;
                };
                generateAiContent(aiGenerateSentenceButton, aiCustomInput, aiSentenceResultsSection, aiSentenceContent, promptGenerator, schema, contentRenderer);
            });

            aiGenerateRelatedWordsButton.addEventListener('click', () => {
                const promptGenerator = (word) => `Với từ tiếng Trung "${word}", hãy tạo một mảng JSON gồm 20 đối tượng, mỗi đối tượng có thuộc tính "word" (từ tiếng Trung), "pinyin" (phiên âm pinyin), và "meaning" (nghĩa tiếng Việt).`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "word": { "type": "STRING" },
                            "pinyin": { "type": "STRING" },
                            "meaning": { "type": "STRING" }
                        },
                        "required": ["word", "pinyin", "meaning"]
                    }
                };
                const contentRenderer = (data, element) => {
                    const relatedWords = Array.isArray(data) ? data : [];
                    let htmlContent = '<ul class="list-disc list-inside space-y-1">';
                    if (relatedWords.length > 0) {
                        relatedWords.forEach(relWord => { htmlContent += `<li><strong>${relWord.word}</strong> (${relWord.pinyin}): ${relWord.meaning}</li>`; });
                    } else {
                        htmlContent += '<li>Không có từ liên quan nào được tạo.</li>';
                    }
                    htmlContent += '</ul>';
                    element.innerHTML = htmlContent;
                };
                generateAiContent(aiGenerateRelatedWordsButton, aiCustomInput, aiRelatedWordsResultsSection, aiRelatedWordsContent, promptGenerator, schema, contentRenderer);
            });
           
            function chunkText(text, maxSize) {
                const chunks = [];
                if (!text) return chunks;
                const sentences = text.match(/[^。！？\n\r]+[。！？\n\r]?/g) || [text];
                let currentChunk = '';
                for (const sentence of sentences) {
                    if (currentChunk.length + sentence.length > maxSize && currentChunk.length > 0) {
                        chunks.push(currentChunk);
                        currentChunk = sentence;
                    } else {
                        currentChunk += sentence;
                    }
                }
                if (currentChunk) chunks.push(currentChunk);
                return chunks.filter(c => c.trim() !== '');
            }

            function stopChunkProcessing() {
                isProcessingChunks = false;
                isPaused = false;
                chunkControls.classList.add('hidden');
            }

            async function processNextChunk() {
                if (!isProcessingChunks || isPaused) {
                    if (!isProcessingChunks) {
                         chunkControls.classList.add('hidden');
                    }
                    return;
                }

                if (currentChunkIndex >= processingQueue.length) {
                    chunkStatus.textContent = 'Hoàn thành!';
                    setTimeout(stopChunkProcessing, 1000);
                    return;
                }
               
                chunkStatus.textContent = `Đang xử lý đoạn ${currentChunkIndex + 1} / ${processingQueue.length}...`;
                const chunk = processingQueue[currentChunkIndex];
                await currentProcessFunction(chunk, currentResultContainer, currentLoadingSpinner, true);
               
                currentChunkIndex++;
                processNextChunk();
            }

            function startChunkProcessing(button, section, resultContainer, loadingSpinner, processFunction) {
                if (!currentRawText) return;
                if (isProcessingChunks) {
                    showNotification("Một tác vụ khác đang được xử lý. Vui lòng đợi hoặc dừng tác vụ hiện tại.", "error");
                    return;
                }

                section.classList.remove('hidden');
                resultContainer.innerHTML = '';
               
                processingQueue = chunkText(currentRawText, 200);
                currentChunkIndex = 0;
                isProcessingChunks = true;
                isPaused = false;
                currentProcessFunction = processFunction;
                currentResultContainer = resultContainer;
                currentLoadingSpinner = loadingSpinner;
               
                processPauseResumeBtn.textContent = 'Tạm dừng';
                chunkControls.classList.remove('hidden');

                processNextChunk();
            }
           
            pinyinButton.addEventListener('click', () => startChunkProcessing(pinyinButton, pinyinTextSection, pinyinContentDiv, pinyinLoadingSpinner, processPinyinChunk));
            segmentTextButton.addEventListener('click', () => startChunkProcessing(segmentTextButton, segmentedTextSection, segmentedContentDiv, segmentLoadingSpinner, processSegmentationChunk));
            explainTextButton.addEventListener('click', () => startChunkProcessing(explainTextButton, explanationSection, explanationContentDiv, explanationLoadingSpinner, processExplanationChunk));
            translateFullTextButton.addEventListener('click', () => startChunkProcessing(translateFullTextButton, fullTranslationSection, fullTranslationContent, fullTranslationLoadingSpinner, processTranslationChunk));

            processPauseResumeBtn.addEventListener('click', () => {
                isPaused = !isPaused;
                processPauseResumeBtn.textContent = isPaused ? 'Tiếp tục' : 'Tạm dừng';
                if (!isPaused) {
                    processNextChunk();
                }
            });

            processStopBtn.addEventListener('click', stopChunkProcessing);


            async function processPinyinChunk(chunk, container, spinner, append = false) {
                 spinner.style.display = 'block';
                 try {
                    const prompt = `Cho đoạn văn bản tiếng Trung sau, hãy chuyển đổi nó thành một mảng các đối tượng JSON. Mỗi đối tượng đại diện cho một ký tự hoặc một dấu câu. Nếu là ký tự tiếng Trung, đối tượng phải có thuộc tính "char" và "pinyin". Nếu là dấu câu hoặc ký tự khác, đối tượng chỉ có thuộc tính "char". Ví dụ: '你好，世界！' -> [{"char": "你", "pinyin": "nǐ"}, {"char": "好", "pinyin": "hǎo"}, {"char": "，"}, {"char": "世", "pinyin": "shì"}, {"char": "界", "pinyin": "jiè"}, {"char": "！"}]. Đây là văn bản cần xử lý:\n\n${chunk}`;
                    const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "char": { "type": "STRING" }, "pinyin": { "type": "STRING" } } } };
                    const jsonString = await callAI(prompt, "application/json", schema);
                    const pinyinData = JSON.parse(jsonString);

                    pinyinData.forEach(item => {
                        if (item.pinyin) {
                            const ruby = document.createElement('ruby');
                            ruby.className = 'word-clickable';
                            ruby.textContent = item.char;
                            const rt = document.createElement('rt');
                            rt.textContent = item.pinyin;
                            ruby.appendChild(rt);
                            ruby.addEventListener('click', (event) => {
                                event.stopPropagation();
                                openLookupModal(item.char, event);
                                aiCustomInput.value = item.char;
                                if (autoPlayToggle.checked) {
                                    speakWord(item.char);
                                }
                            });
                            container.appendChild(ruby);
                        } else {
                            const span = document.createElement('span');
                            span.textContent = item.char;
                            container.appendChild(span);
                        }
                    });
                 } catch (error) {
                     container.innerHTML += `<p class="text-red-600">Lỗi khi thêm Pinyin: ${error.message}.</p>`;
                 } finally {
                     spinner.style.display = 'none';
                 }
            }
           
            async function processSegmentationChunk(chunk, container, spinner, append = false) {
                 spinner.style.display = 'block';
                 try {
                    const prompt = `Phân đoạn văn bản tiếng Trung sau thành các từ có nghĩa và dấu câu, kèm theo phiên âm pinyin cho mỗi từ. Trả về một mảng JSON các đối tượng, mỗi đối tượng có thuộc tính "word" và "pinyin". Đối với dấu câu, "pinyin" sẽ là một chuỗi rỗng. Ví dụ: '我爱北京天安门。' -> [{"word":"我","pinyin":"wǒ"},{"word":"爱","pinyin":"ài"},{"word":"北京","pinyin":"Běijīng"},{"word":"天安门","pinyin":"Tiān'ānmén"},{"word":"。","pinyin":""}]. Đây là văn bản cần xử lý:\n\n${chunk}`;
                    const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "pinyin": { "type": "STRING" } }, required: ["word", "pinyin"] } };
                    const jsonString = await callAI(prompt, "application/json", schema);
                    const segments = JSON.parse(jsonString);

                    segments.forEach(seg => {
                        if (seg.word.match(/[\u4e00-\u9fa5]/)) {
                            const ruby = document.createElement('ruby');
                            ruby.className = 'segmented-word';
                            ruby.textContent = seg.word;
                            const rt = document.createElement('rt');
                            rt.textContent = seg.pinyin;
                            ruby.appendChild(rt);
                            ruby.addEventListener('click', (event) => {
                                event.stopPropagation();
                                openLookupModal(seg.word, event);
                                aiCustomInput.value = seg.word;
                                if (autoPlayToggle.checked) {
                                    speakWord(seg.word);
                                }
                            });
                            container.appendChild(ruby);
                        } else {
                            const span = document.createElement('span');
                            span.textContent = seg.word;
                            container.appendChild(span);
                        }
                    });
                    container.appendChild(document.createTextNode(' '));
                 } catch (error) {
                     container.innerHTML += `<p class="text-red-600">Lỗi khi tách cụm từ: ${error.message}.</p>`;
                 } finally {
                     spinner.style.display = 'none';
                 }
            }
           
            async function processExplanationChunk(chunk, container, spinner, append = false) {
                 spinner.style.display = 'block';
                 try {
                    const prompt = `Giải thích nội dung ngữ pháp tiếng Trung sau đây một cách chi tiết và dễ hiểu bằng tiếng Việt, dành cho người học tiếng Trung. Tập trung vào các khái niệm ngữ pháp, ví dụ và quy tắc được trình bày trong văn bản:\n\n${chunk}`;
                    const explanation = await callAI(prompt, "text/plain");
                    container.innerHTML += explanation.replace(/\n/g, '<br>') + '<hr class="my-4">';
                 } catch (error) {
                     container.innerHTML += `<p class="text-red-600">Lỗi khi gọi AI để giải thích: ${error.message}.</p>`;
                 } finally {
                     spinner.style.display = 'none';
                 }
            }
           
            async function processTranslationChunk(chunk, container, spinner, append = false) {
                 spinner.style.display = 'block';
                 try {
                    const prompt = `Dịch đoạn văn bản tiếng Trung sau đây sang tiếng Việt. Chỉ trả về bản dịch, không thêm bất kỳ lời giải thích nào khác:\n\n${chunk}`;
                    const translation = await callAI(prompt, "text/plain");
                    container.innerText += translation + ' ';
                 } catch (error) {
                     container.innerHTML += `<p class="text-red-600">Lỗi khi dịch văn bản: ${error.message}.</p>`;
                 } finally {
                     spinner.style.display = 'none';
                 }
            }


            fileUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                fileNameSpan.textContent = file.name;
                textInputArea.value = '';
                textDisplay.textContent = 'Đang xử lý tệp tin...';
                const reader = new FileReader();

                if (file.name.endsWith('.docx')) {
                    reader.onload = (e) => {
                        window.mammoth.convertToHtml({ arrayBuffer: e.target.result })
                            .then(result => processNewContent(result.value, true))
                            .catch(error => {
                                console.error("Error processing DOCX:", error);
                                textDisplay.textContent = `Lỗi khi xử lý tệp DOCX: ${error.message}`;
                            });
                    };
                    reader.readAsArrayBuffer(file);
                } else { // Handle .txt files
                    reader.onload = (e) => processNewContent(e.target.result, false);
                    reader.readAsText(file);
                }
            });

            processTextButton.addEventListener('click', () => {
                const text = textInputArea.value.trim();
                if (!text) {
                    showNotification("Vui lòng nhập văn bản vào ô.", "error");
                    return;
                }
                fileUploadInput.value = '';
                fileNameSpan.textContent = 'Văn bản đã nhập';
                processNewContent(text, false);
            });

            // --- TTS Implementation ---
            function updatePlayPauseUI() {
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playPauseText.textContent = 'Tạm dừng';
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    playPauseText.textContent = 'Phát';
                    if (!speechSynthesis.speaking) {
                        ttsProgressBar.style.width = '0%';
                    }
                }
            }

            function populateVoiceList() {
                voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('zh'));
                ttsVoiceSelect.innerHTML = '';
                if (voices.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'Không có giọng đọc tiếng Trung';
                    ttsVoiceSelect.appendChild(option);
                    return;
                }
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    ttsVoiceSelect.appendChild(option);
                });
            }

            function speakWord(text) {
                if (!text) return;
                speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                const selectedVoiceName = ttsVoiceSelect.selectedOptions[0]?.getAttribute('data-name');
                utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                utterance.rate = ttsRateSlider.value;
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            }

            function speak(text, startIndex = 0) {
                speechSynthesis.cancel();
                speechStartIndex = startIndex;
                const textToSpeak = text.substring(startIndex);
                if (!textToSpeak) return;

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                const selectedVoiceName = ttsVoiceSelect.selectedOptions[0]?.getAttribute('data-name');
                utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                utterance.rate = ttsRateSlider.value;
                utterance.lang = 'zh-CN';

                utterance.onboundary = (event) => {
                    const totalChars = currentRawText.length;
                    const spokenChars = speechStartIndex + event.charIndex;
                    const progress = totalChars > 0 ? (spokenChars / totalChars) * 100 : 0;
                    ttsProgressBar.style.width = `${progress}%`;
                };

                utterance.onend = () => {
                    ttsProgressBar.style.width = '0%';
                    speechStartIndex = 0;
                    updatePlayPauseUI();
                };

                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    updatePlayPauseUI();
                };
               
                speechSynthesis.speak(utterance);
                setTimeout(updatePlayPauseUI, 50);
            }

            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            ttsPlayPauseBtn.addEventListener('click', () => {
                if (!currentRawText) return;
                if (speechSynthesis.speaking) {
                    if (speechSynthesis.paused) {
                        speechSynthesis.resume();
                    } else {
                        speechSynthesis.pause();
                    }
                } else {
                    speak(currentRawText, 0);
                }
                 setTimeout(updatePlayPauseUI, 50);
            });

            ttsStopBtn.addEventListener('click', () => {
                speechSynthesis.cancel();
                ttsProgressBar.style.width = '0%';
                speechStartIndex = 0;
                updatePlayPauseUI();
            });

            ttsRateSlider.addEventListener('input', (e) => {
                const rate = parseFloat(e.target.value);
                ttsRateLabel.textContent = `${rate.toFixed(1)}x`;
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    const currentProgress = parseFloat(ttsProgressBar.style.width) || 0;
                    const seekIndex = Math.floor((currentProgress / 100) * currentRawText.length);
                    speak(currentRawText, seekIndex);
                }
            });
           
            ttsProgressContainer.addEventListener('click', (e) => {
                if (!currentRawText) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = e.currentTarget.offsetWidth;
                const percentage = clickX / width;
               
                let seekIndex = Math.floor(percentage * currentRawText.length);
               
                const lastSpace = currentRawText.lastIndexOf(' ', seekIndex);
                if (lastSpace !== -1) {
                    seekIndex = lastSpace + 1;
                }

                speak(currentRawText, seekIndex);
            });


            document.querySelectorAll('.toggle-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const content = e.target.closest('.section-header').nextElementSibling;
                    content.classList.toggle('hidden');
                    button.textContent = content.classList.contains('hidden') ? 'Hiển thị' : 'Thu gọn';
                });
            });
           
            function copyToClipboard(text) {
                 const textArea = document.createElement("textarea");
                 textArea.value = text;
                 textArea.style.position = "fixed";
                 textArea.style.top = "-9999px";
                 textArea.style.left = "-9999px";
                 document.body.appendChild(textArea);
                 textArea.select();
                 try {
                     document.execCommand('copy');
                     showNotification('Đã sao chép vào clipboard!');
                 } catch (err) {
                     console.error('Lỗi khi sao chép: ', err);
                     showNotification('Lỗi khi sao chép!', 'error');
                 }
                 document.body.removeChild(textArea);
            }

            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const content = e.target.closest('.section-header').nextElementSibling;
                    copyToClipboard(content.innerText);
                });
            });

            toggleMainTextButton.addEventListener('click', () => {
                textDisplay.classList.toggle('hidden');
                toggleMainTextButton.textContent = textDisplay.classList.contains('hidden') ? 'Hiển thị' : 'Thu gọn';
            });
           
            copyMainTextButton.addEventListener('click', () => {
                 copyToClipboard(currentRawText);
            });

            document.addEventListener('mouseup', (e) => {
                setTimeout(() => {
                    const selection = window.getSelection();
                    if (!selection || selection.isCollapsed) {
                        return;
                    }

                    const selectedText = selection.toString().trim();
                    const targetIsPopup = selectionPopup.contains(e.target) || modalContentInner.contains(e.target);
                    const targetIsWord = e.target.closest('.word-clickable');

                    if (!selectedText || targetIsPopup || targetIsWord) {
                        return;
                    }

                    lookupModalOverlay.style.display = 'none';
                    selectionPopup.style.visibility = 'hidden';
                    selectionPopup.classList.remove('hidden');
                   
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    const popupWidth = selectionPopup.offsetWidth;
                    const popupHeight = selectionPopup.offsetHeight;
                    const margin = 10;
                    let top = rect.bottom + window.scrollY + 5;
                    let left = rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2);
                   
                    if (left + popupWidth > window.innerWidth - margin) left = window.innerWidth - popupWidth - margin;
                    if (left < margin) left = margin;
                    if (top + popupHeight > window.innerHeight + window.scrollY - margin) {
                        top = rect.top + window.scrollY - popupHeight - 5;
                    }
                    if (top < window.scrollY + margin) top = window.scrollY + margin;

                    selectionPopup.style.top = `${top}px`;
                    selectionPopup.style.left = `${left}px`;
                    selectionPopup.style.visibility = 'visible';
                   
                    copySelectionButton.onclick = () => {
                        copyToClipboard(selectedText);
                        selectionPopup.classList.add('hidden');
                    };

                    translateSelectionButton.onclick = async () => {
                        selectionTranslateResultDiv.classList.add('hidden');
                        selectionTranslateSpinner.style.display = 'block';
                        const translation = await getTranslation(selectedText, selectionTranslateResultDiv);
                        selectionTranslateSpinner.style.display = 'none';
                        if (translation.meaning !== 'Không thể dịch.') {
                            selectionTranslateResultDiv.innerHTML = `<strong>Dịch:</strong> ${translation.pinyin} - ${translation.meaning}`;
                            selectionTranslateResultDiv.classList.remove('hidden');
                        }
                    };
                   
                    pronounceSelectionButton.onclick = () => {
                        speakWord(selectedText);
                    };

                    hanziiSelectionLink.href = `https://hanzii.net/search/word/${encodeURIComponent(selectedText)}?hl=vi`;

                    selectionTranslateResultDiv.classList.add('hidden');
                    selectionTranslateSpinner.style.display = 'none';
                }, 0);
            });
            
            // --- API Key Management ---
            saveApiKeyButton.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    apiKeyStatus.textContent = 'API Key đã được lưu!';
                    apiKeyStatus.style.color = '#16a34a'; // green
                    setTimeout(() => { apiKeyStatus.textContent = ''; }, 3000);
                } else {
                    apiKeyStatus.textContent = 'Vui lòng nhập một API Key hợp lệ.';
                    apiKeyStatus.style.color = '#dc2626'; // red
                    setTimeout(() => { apiKeyStatus.textContent = ''; }, 3000);
                }
            });

            // Load saved API key on startup
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
        }
       
        window.addEventListener('load', mainApp);

    </script>
</body>
</html>
