<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ti·∫øng Trung Dichi v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #333; min-height: 100vh; }
        
        /* Z-Index Strategy */
        #settings-sidebar { transition: transform 0.3s ease-in-out; z-index: 3000; }
        .sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); z-index: 2999; }
        #open-sidebar-btn { z-index: 2900; }

        .container { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 1.5rem; width: 100%; max-width: 900px; margin: 20px auto; overflow: hidden; position: relative; z-index: 1; }
        
        /* Content Box */
        .text-content { 
            white-space: pre-wrap; word-wrap: break-word; line-height: 2.2; margin-top: 1rem; padding: 1rem; 
            background-color: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; 
            min-height: 150px; max-height: 60vh; overflow-y: auto; font-size: 1.15rem; 
        }
        
        .word-clickable, .segmented-word ruby { cursor: pointer; padding: 2px; border-radius: 4px; transition: background-color 0.2s ease; display: inline-flex; flex-direction: column-reverse; align-items: center; line-height: 1.2; }
        .word-clickable:hover, .segmented-word:hover { background-color: #e0e7ff; }
        .segmented-word { border: 1px solid #d1d5db; margin: 2px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.0); z-index: 3100; display: none; }
        .modal-content { background-color: #fefefe; padding: 15px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); position: absolute; max-width: 280px; z-index: 3200; border: 1px solid #e5e7eb; animation: fadeIn 0.2s ease-out; cursor: grab; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Buttons */
        .button-base { padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .button-base:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-base:hover:not(:disabled) { transform: translateY(-1px); }
        .button-base:active:not(:disabled) { transform: translateY(0); }
        .button-primary { background-color: #4f46e5; color: white; }
        .button-primary:hover:not(:disabled) { background-color: #4338ca; }
        .button-secondary { background-color: #6b7280; color: white; }
        .button-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .button-danger { background-color: #dc2626; color: white; }
        .button-danger:hover:not(:disabled) { background-color: #b91c1c; }
        
        /* Links */
        a.link-button { display: block; background-color: #eff6ff; color: #1d4ed8; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; text-align: center; text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.9rem; }
        a.link-button:hover { background-color: #dbeafe; color: #1e40af; }
        #reference-section a { color: #2563eb; text-decoration: underline; cursor: pointer; position: relative; z-index: 10; }
        #reference-section a:hover { color: #1e40af; }
        #reference-section ul { list-style-type: disc; padding-left: 25px; }
        #reference-section li { margin-bottom: 0.5rem; }

        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .section-header h3 { font-size: 1.25rem; font-weight: 600; color: #333; margin: 0; }
        .content-section { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px; margin-top: 20px; border: 1px solid #e5e7eb; position: relative; }
        
        .text-selection-popup { max-width: 320px; padding: 10px; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid #ccc; background-color: #fff; cursor: grab; position: absolute; z-index: 3300; }
        .text-selection-popup .button-secondary, .text-selection-popup .button-primary { padding: 6px 10px; font-size: 0.8rem; width: 100%; }
        .close-button { position: absolute; top: 4px; right: 8px; font-size: 1.5rem; font-weight: bold; color: #9ca3af; cursor: pointer; line-height: 1; padding: 2px; }
        .close-button:hover { color: #374151; }
        
        .tts-controls { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background-color: #f9fafb; }
        #tts-progress-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; cursor: pointer; height: 10px; }
        #tts-progress-bar { height: 100%; background-color: #4f46e5; border-radius: 9999px; width: 0%; transition: width 0.1s linear; }
        .resizable-media { resize: vertical; overflow: hidden; min-height: 150px; height: auto; background: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; }
        .resizable-media video { width: 100%; height: 100%; object-fit: contain; }
        
        .task-progress-wrapper { width: 100%; margin-top: 8px; display: none; }
        .task-progress-bar-bg { width: 100%; background-color: #e5e7eb; border-radius: 999px; height: 6px; overflow: hidden; }
        .task-progress-bar-fill { height: 100%; background-color: #10b981; width: 0%; transition: width 0.3s ease; }
        .task-status-text { font-size: 0.75rem; color: #6b7280; margin-top: 4px; display: flex; justify-content: space-between; }
        .task-controls { display: flex; gap: 5px; align-items: center; }
        
        .menu-link { display: block; padding: 8px 12px; color: #4b5563; font-weight: 500; border-radius: 6px; transition: background 0.2s; cursor: pointer; text-decoration: none; }
        .menu-link:hover { background-color: #f3f4f6; color: #4f46e5; }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 hidden"></div>
    
    <div id="settings-sidebar" class="fixed top-0 left-0 h-full w-80 sm:w-96 bg-white shadow-2xl transform -translate-x-full overflow-y-auto flex flex-col">
        <div class="p-6 flex-grow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Menu & C√†i ƒë·∫∑t</h2>
                <button id="close-sidebar" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>

            <div class="mb-6 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wider">M·ª•c l·ª•c</h3>
                <nav class="space-y-1">
                    <a href="#input-section" class="menu-link">üì• Nh·∫≠p li·ªáu & T·∫£i file</a>
                    <a href="#media-player-section" class="menu-link">üé¨ Tr√¨nh ph√°t Media</a>
                    <a href="#tts-section-wrapper" class="menu-link">üîä ƒê·ªçc vƒÉn b·∫£n (TTS)</a>
                    <a href="#main-text-section" class="menu-link">üìÑ VƒÉn b·∫£n g·ªëc</a>
                    <a href="#pinyin-text-section" class="menu-link">üá®üá≥ Pinyin</a>
                    <a href="#segmented-text-section" class="menu-link">‚úÇÔ∏è T√°ch t·ª´</a>
                    <a href="#full-translation-section" class="menu-link">üáªüá≥ B·∫£n d·ªãch</a>
                    <a href="#explanation-section" class="menu-link">üéì Gi·∫£i th√≠ch chi ti·∫øt</a>
                    <a href="#ai-tools-section" class="menu-link">ü§ñ C√¥ng c·ª• t·ª´ v·ª±ng AI</a>
                </nav>
            </div>

            <div class="mb-6 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wider">C·∫•u h√¨nh API</h3>
                <div class="mb-3">
                    <label class="block mb-1 text-sm font-medium text-gray-700">Nh√† cung c·∫•p:</label>
                    <select id="ai-provider-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="gemini">Google Gemini (Free)</option>
                        <option value="deepseek">DeepSeek (Paid)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block mb-1 text-sm font-medium text-gray-700">API Key:</label>
                    <input type="password" id="api-key-input" placeholder="Nh·∫≠p API Key..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm mb-2">
                    <button id="save-api-key-button" class="button-base button-primary w-full">L∆∞u API Key</button>
                </div>
                <p id="api-key-guide" class="text-xs text-gray-500 mb-1"></p>
                <p id="api-key-status" class="text-sm text-green-600 font-medium h-5"></p>
                <div class="mt-2 grid grid-cols-2 gap-2">
                    <div><label class="block mb-1 text-sm font-medium text-gray-700">ƒê·ªô tr·ªÖ (s):</label><input type="number" id="delay-input" value="5" min="0" step="0.5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></div>
                    <div><label class="block mb-1 text-sm font-medium text-gray-700">Chunk Size:</label><input type="number" id="chunk-size-input" value="100" min="10" max="1000" step="10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></div>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between items-center mb-3"><h3 class="font-semibold text-gray-700 text-sm uppercase tracking-wider">Prompt T√πy ch·ªânh</h3><button id="reset-prompts-btn" class="text-xs text-red-500 underline">Reset</button></div>
                <div class="space-y-3">
                    <div><label class="text-xs font-medium text-gray-600">Pinyin:</label><textarea id="prompt-pinyin" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                    <div><label class="text-xs font-medium text-gray-600">T√°ch t·ª´:</label><textarea id="prompt-segment" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                    <div><label class="text-xs font-medium text-gray-600">Gi·∫£i th√≠ch:</label><textarea id="prompt-explain" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                    <div><label class="text-xs font-medium text-gray-600">D·ªãch:</label><textarea id="prompt-translate" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                </div>
            </div>
        </div>
    </div>

    <button id="open-sidebar-btn" class="fixed top-4 left-4 z-50 bg-white p-2 rounded-full shadow-lg border border-gray-200 hover:bg-gray-100 text-gray-700" title="M·ªü c√†i ƒë·∫∑t"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>

    <div class="container">
        <div class="flex justify-between items-start mb-6 pl-12">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">H·ªçc ti·∫øng Trung c√πng Dichi</h1>
            <img src="kieuoanh.jpg" alt="<3" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover border-2 border-white shadow-lg flex-shrink-0" onerror="this.style.display='none'">
        </div>

        <div id="input-section" class="content-section !mt-0">
            <div class="section-header">
                <h3>üì• Nh·∫≠p li·ªáu & T·∫£i file</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="input-content-wrapper">Thu g·ªçn</button>
            </div>
            <div id="input-content-wrapper">
                <div class="space-y-4 mb-4">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <div class="flex items-center space-x-2">
                            <label for="file-upload" class="button-base button-secondary cursor-pointer">T·∫£i l√™n t·ªáp tin .docx</label>
                            <input type="file" id="file-upload" class="hidden" accept=".txt,.docx,.DOCX">
                            <span id="file-name" class="text-gray-600 text-sm"></span>
                        </div>
                    </div>
                    <div class="mt-2 flex flex-col sm:flex-row items-center justify-center gap-2">
                        <input type="url" id="url-input" class="w-full sm:w-auto flex-grow p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="Ho·∫∑c d√°n URL...">
                        <button id="fetch-url-button" class="button-base button-primary w-full sm:w-auto">T·∫£i URL</button>
                    </div>
                    <div class="mt-2">
                        <label class="block mb-2 text-sm font-medium text-gray-700">VƒÉn b·∫£n tr·ª±c ti·∫øp:</label>
                        <textarea id="text-input-area" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="D√°n vƒÉn b·∫£n ti·∫øng Trung v√†o ƒë√¢y..."></textarea>
                        <button id="process-text-button" class="button-base button-primary mt-2">X·ª≠ l√Ω vƒÉn b·∫£n</button>
                    </div>
                    <div class="flex flex-wrap items-center justify-center gap-4 pt-4">
                        <button id="pinyin-button" class="button-base button-secondary">Th√™m Pinyin</button>
                        <button id="segment-text-button" class="button-base button-secondary">T√°ch c·ª•m t·ª´</button>
                        <button id="explain-text-button" class="button-base button-secondary">Gi·∫£i th√≠ch</button>
                        <button id="translate-full-text-button" class="button-base button-secondary">D·ªãch vƒÉn b·∫£n</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="media-player-section" class="content-section">
            <div class="section-header">
                <h3>üé¨ Tr√¨nh ph√°t Media</h3>
                <div><label for="media-upload" class="button-base button-primary text-xs px-3 py-1 mr-2 cursor-pointer">T·∫£i file</label><input type="file" id="media-upload" class="hidden" accept="audio/*,video/*"><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="media-container">Thu g·ªçn</button></div>
            </div>
            <div id="media-container" class="hidden">
                <div class="resizable-media mb-3" id="video-wrapper"><video id="main-media-player" controls style="display:none;"></video></div>
                <audio id="main-audio-player" controls class="w-full" style="display:none;"></audio>
                <p id="media-filename" class="text-sm text-center text-gray-500 mb-2 italic">Ch∆∞a c√≥ file.</p>
                <div id="media-controls" class="flex flex-wrap justify-center items-center gap-3 p-2 bg-gray-50 rounded border border-gray-200 opacity-50 pointer-events-none">
                    <button id="media-rewind" class="button-base button-secondary text-xs">-10s</button>
                    <button id="media-forward" class="button-base button-secondary text-xs">+10s</button>
                    <div class="flex items-center space-x-2 ml-2 border-l pl-3 border-gray-300"><label class="text-xs font-medium">T·ªëc ƒë·ªô:</label><select id="media-rate" class="p-1 border border-gray-300 rounded text-xs"><option value="0.5">0.5x</option><option value="1" selected>1.0x</option><option value="1.5">1.5x</option><option value="2">2.0x</option></select></div>
                </div>
            </div>
        </div>

        <div id="tts-section-wrapper" class="content-section">
             <div class="section-header">
                <h3>üîä C√¥ng c·ª• ƒë·ªçc vƒÉn b·∫£n (TTS)</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="tts-inner-content">Thu g·ªçn</button>
            </div>
            <div id="tts-inner-content" class="tts-controls space-y-3">
                <div class="flex items-center gap-4">
                    <button id="tts-play-pause" class="button-base button-primary flex items-center justify-center w-28">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1zm6 0a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span id="play-pause-text" class="ml-2">Ph√°t</span>
                    </button>
                    <button id="tts-stop" class="button-base button-secondary">D·ª´ng</button>
                    <div id="tts-progress-container" class="flex-grow"><div id="tts-progress-bar"></div></div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div class="flex items-center space-x-2"><label class="text-sm font-medium">Gi·ªçng:</label><select id="tts-voice" class="p-2 border border-gray-300 rounded-md shadow-sm text-sm"></select></div>
                    <div class="flex items-center space-x-2"><label class="text-sm font-medium">T·ªëc ƒë·ªô:</label><input type="range" id="tts-rate" min="0.5" max="2" value="1" step="0.1" class="w-24"><span id="tts-rate-label" class="text-sm font-mono">1.0x</span></div>
                    <div class="flex items-center space-x-2"><input type="checkbox" id="auto-play-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label class="text-sm font-medium">Auto ph√°t</label></div>
                </div>
            </div>
        </div>
        
        <div id="main-text-section" class="content-section">
            <div class="section-header"><h3>üìÑ VƒÉn b·∫£n g·ªëc</h3><div><button id="copy-main-text-button" class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2" data-target="text-display">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="text-display">Thu g·ªçn</button></div></div>
            <div id="text-display" class="text-content">Vui l√≤ng t·∫£i l√™n m·ªôt t·ªáp tin ho·∫∑c nh·∫≠p vƒÉn b·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
        </div>

        <div id="pinyin-text-section" class="content-section hidden">
            <div class="section-header"><h3>üá®üá≥ VƒÉn b·∫£n v·ªõi Pinyin (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="pinyin-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="pinyin-content">Thu g·ªçn</button><button id="stop-pinyin" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-pinyin" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="pinyin-content" class="text-gray-700 text-content section-content"></div>
        </div>
        <div id="segmented-text-section" class="content-section hidden">
            <div class="section-header"><h3>‚úÇÔ∏è VƒÉn b·∫£n theo c·ª•m t·ª´ (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="segmented-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="segmented-content">Thu g·ªçn</button><button id="stop-segment" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-segment" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="segmented-content" class="text-gray-700 text-content section-content" style="line-height: 2.5;"></div>
        </div>
        <div id="full-translation-section" class="content-section hidden">
            <div class="section-header"><h3>üáªüá≥ B·∫£n d·ªãch (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="full-translation-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="full-translation-content">Thu g·ªçn</button><button id="stop-translate" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-translate" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="full-translation-content" class="text-gray-700 text-content section-content"></div>
        </div>
        <div id="explanation-section" class="content-section hidden">
            <div class="section-header"><h3>üéì Gi·∫£i th√≠ch n·ªôi dung (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="explanation-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="explanation-content">Thu g·ªçn</button><button id="stop-explain" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-explain" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="explanation-content" class="text-gray-700 text-content section-content"></div>
        </div>
        
        <div id="ai-tools-section" class="mt-8 content-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">ü§ñ C√¥ng c·ª• AI</h3>
            <div class="flex items-center gap-2"><input type="text" id="ai-custom-input" placeholder="Nh·∫≠p t·ª´ ho·∫∑c c·ª•m t·ª´..." class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full"></div>
            <div class="flex items-center justify-center gap-2 mt-2">
                <button id="ai-generate-sentence-button" class="button-base button-primary">T·∫°o c√¢u v√≠ d·ª•</button>
                <button id="ai-generate-related-words-button" class="button-base button-primary">T·∫°o t·ª´ li√™n quan</button>
            </div>
            <div id="loading-spinner" class="loading-spinner"></div>
            <div id="ai-sentence-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden"><div class="section-header"><h3>C√¢u v√≠ d·ª•</h3><div><button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2" data-target="ai-sentence-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="ai-sentence-content">Thu g·ªçn</button></div></div><div id="ai-sentence-content" class="section-content text-left"></div></div>
            <div id="ai-related-words-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden"><div class="section-header"><h3>T·ª´ li√™n quan</h3><div><button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2" data-target="ai-related-words-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="ai-related-words-content">Thu g·ªçn</button></div></div><div id="ai-related-words-content" class="section-content text-left"></div></div>
        </div>

        <div id="reference-section" class="content-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">Trang web tham kh·∫£o</h3>
            <ul>
                <li><a href="https://hanzii.net/" target="_blank">Hanzii.net</a> - T·ª´ ƒëi·ªÉn v√† c√¥ng c·ª• h·ªçc ti·∫øng Trung.</li>
                <li><a href="https://hvdic.thivien.net/" target="_blank">T·ª´ ƒëi·ªÉn H√°n N√¥m</a> - Tra c·ª©u H√°n t·ª±, N√¥m.</li>
                <li><a href="https://www.mdbg.net/chinese/dictionary" target="_blank">MDBG Chinese Dictionary</a> - T·ª´ ƒëi·ªÉn Trung-Anh.</li>
                <li><a href="https://vtudien.com/trung-viet" target="_blank">Vtudien.com</a> - T·ª´ ƒëi·ªÉn ƒëa ng√¥n ng·ªØ.</li>
                <li>* Web n√†y ƒë∆∞·ª£c t·∫∑ng cho <a href="https://www.facebook.com/kieuoanhdichi" target="_blank">Ki·ªÅu Oanh</a> - Gi√°o vi√™n ti·∫øng Trung.</li>
            </ul>
        </div>
        
        <div id="text-stats-section" class="hidden content-section">
             <h3 class="text-xl font-semibold mb-3 text-gray-800">Th·ªëng k√™</h3>
             <p class="text-sm text-gray-600">ƒê·ªô d√†i: <span id="char-count" class="font-bold">0</span> k√Ω t·ª±</p>
             <p class="text-sm text-gray-600">S·ªë ƒëo·∫°n: <span id="word-count" class="font-bold">0</span> ƒëo·∫°n</p>
        </div>
        
        <div id="lookup-modal" class="modal-overlay">
            <div id="modal-content-inner" class="modal-content">
                <button id="close-lookup-modal" class="close-button">&times;</button>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Tra: <span id="selected-word-modal" class="font-bold text-indigo-600"></span></h2>
                <div class="flex items-center gap-2 mt-2 mb-3"><button id="pronounce-word-button" class="button-base button-primary flex-1">Ph√°t √¢m</button><button id="copy-word-button" class="button-base button-secondary flex-1">Sao ch√©p</button></div>
                <div class="space-y-2">
                    <a id="hanzii-link" href="#" target="_blank" class="link-button">Hanzii</a>
                    <a id="mdbg-link" href="#" target="_blank" class="link-button">MDBG</a>
                    <a id="youglish-link" href="#" target="_blank" class="link-button">YouGlish</a>
                    <a id="vtudien-link" href="#" target="_blank" class="link-button">Vtudien</a>
                </div>
                <div id="google-translate-result" class="mt-4"></div>
                <div id="translate-loading-spinner" class="loading-spinner"></div>
            </div>
        </div>
        <div id="selection-popup" class="modal-content text-selection-popup hidden">
            <button id="close-selection-popup" class="close-button">&times;</button>
            <div class="flex flex-col space-y-2">
                <button id="copy-selection-button" class="button-base button-secondary w-full">Sao ch√©p</button>
                <button id="translate-selection-button" class="button-base button-primary w-full">D·ªãch</button>
                <button id="pronounce-selection-button" class="button-base button-primary w-full">Ph√°t √¢m</button>
                <a id="hanzii-selection-link" href="#" target="_blank" class="link-button">Tra Hanzii</a>
            </div>
            <div id="selection-translate-result" class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-gray-700 text-sm hidden"></div>
            <div id="selection-translate-spinner" class="loading-spinner"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        function mainApp() {
            // 1. DEFINITIONS (Hoisted Helpers)
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div'); notification.textContent = message;
                notification.style.position = 'fixed'; notification.style.bottom = '20px'; notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)'; notification.style.padding = '10px 20px';
                notification.style.borderRadius = '8px'; notification.style.color = 'white';
                notification.style.backgroundColor = type === 'success' ? '#4f46e5' : '#dc2626';
                notification.style.zIndex = '3500'; notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease'; document.body.appendChild(notification);
                setTimeout(() => { notification.style.opacity = '1'; }, 10);
                setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 300); }, 3000);
            }

            function copyToClipboard(text) {
                if (!text) return;
                const textArea = document.createElement("textarea"); textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.top = "-9999px"; document.body.appendChild(textArea);
                textArea.select(); 
                try { document.execCommand('copy'); showNotification('ƒê√£ sao ch√©p!'); } catch (err) { showNotification('L·ªói sao ch√©p!', 'error'); }
                document.body.removeChild(textArea);
            }

            function copyHtmlToClipboard(element) {
                if (!element) return;
                if (typeof element === 'string') { copyToClipboard(element); return; }
                // Simply copy text content for safety, or select node for HTML
                const range = document.createRange(); range.selectNode(element);
                window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
                try { document.execCommand('copy'); showNotification('ƒê√£ sao ch√©p!'); } catch (err) { showNotification('L·ªói sao ch√©p!', 'error'); }
                window.getSelection().removeAllRanges();
            }

            function makeDraggable(element) {
                let isDragging = false, initialMouseX, initialMouseY, initialElementLeft, initialElementTop;
                element.addEventListener("mousedown", (e) => {
                    if (e.target.closest('a, button, .close-button')) return;
                    isDragging = true; element.style.cursor = 'grabbing'; element.style.zIndex = 3301;
                    const rect = element.getBoundingClientRect(); initialElementLeft = rect.left; initialElementTop = rect.top; initialMouseX = e.clientX; initialMouseY = e.clientY; e.preventDefault(); e.stopPropagation();
                });
                document.addEventListener("mousemove", (e) => { if (isDragging) { e.preventDefault(); element.style.left = `${initialElementLeft + e.clientX - initialMouseX}px`; element.style.top = `${initialElementTop + e.clientY - initialMouseY}px`; } });
                document.addEventListener("mouseup", () => { if (isDragging) { isDragging = false; element.style.cursor = 'grab'; element.style.zIndex = 3200; } });
            }

            let activeMediaPlayer = null; 
            let voices = [];
            const ttsVoiceSelect = document.getElementById('tts-voice');
            const ttsRateSlider = document.getElementById('tts-rate');

            // FIX 1: ROBUST VOICE LOADING
            function populateVoiceList() {
                voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('zh') || voice.lang.includes('CN') || voice.lang.includes('TW'));
                ttsVoiceSelect.innerHTML = '';
                if (voices.length === 0) {
                    // Try fallback if no Chinese voices found
                    const allVoices = speechSynthesis.getVoices();
                    if(allVoices.length > 0) {
                        allVoices.forEach(v => ttsVoiceSelect.appendChild(new Option(`${v.name} (${v.lang})`, v.name)));
                    } else {
                        ttsVoiceSelect.appendChild(new Option('ƒêang t·∫£i gi·ªçng...', ''));
                    }
                } else {
                    voices.forEach(v => ttsVoiceSelect.appendChild(new Option(`${v.name} (${v.lang})`, v.name)));
                }
            }
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
            // Fallback retry for Chrome
            setTimeout(populateVoiceList, 1000);

            function speakWord(text) {
                if(activeMediaPlayer && !activeMediaPlayer.paused) activeMediaPlayer.pause();
                if (!text) return; 
                speechSynthesis.cancel(); 
                const u = new SpeechSynthesisUtterance(text);
                // Try getting selected voice, fallback to first available
                const selectedName = ttsVoiceSelect.value;
                if(selectedName) u.voice = voices.find(v => v.name === selectedName);
                u.rate = ttsRateSlider.value; 
                u.lang = 'zh-CN'; 
                speechSynthesis.speak(u);
            }

            // 2. CONSTANTS
            const DEFAULT_PROMPTS = {
                pinyin: `Ph√¢n t√≠ch ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Trung sau t·ª´ng k√Ω t·ª± m·ªôt. B·∫ÆT BU·ªòC tr·∫£ v·ªÅ JSON m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng. M·ªói ƒë·ªëi t∆∞·ª£ng g·ªìm "char" (k√Ω t·ª±) v√† "pinyin". \nQUAN TR·ªåNG: V·ªõi m·ªói k√Ω t·ª± H√°n, "pinyin" KH√îNG ƒê∆Ø·ª¢C ƒê·ªÇ TR·ªêNG. V·ªõi d·∫•u c√¢u ho·∫∑c xu·ªëng d√≤ng, "pinyin" l√† chu·ªói r·ªóng. \nV√≠ d·ª• chu·∫©n: '‰Ω†Â•Ω' -> [{"char": "‰Ω†", "pinyin": "n«ê"}, {"char": "Â•Ω", "pinyin": "h«éo"}]. \nƒê√¢y l√† vƒÉn b·∫£n:\n\n{{TEXT}}`,
                segment: `Ph√¢n ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Trung sau th√†nh c√°c t·ª´ c√≥ nghƒ©a, d·∫•u c√¢u, v√† k√Ω t·ª± xu·ªëng d√≤ng, k√®m theo phi√™n √¢m pinyin cho m·ªói t·ª´. Tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ thu·ªôc t√≠nh "word" v√† "pinyin". ƒê·ªëi v·ªõi d·∫•u c√¢u ho·∫∑c k√Ω t·ª± xu·ªëng d√≤ng (\\n), "pinyin" s·∫Ω l√† m·ªôt chu·ªói r·ªóng. V√≠ d·ª•: 'ÊàëÁà±Âåó‰∫¨„ÄÇ\\n' -> [{"word":"Êàë","pinyin":"w«í"},{"word":"Áà±","pinyin":"√†i"},{"word":"Âåó‰∫¨","pinyin":"Bƒõijƒ´ng"},{"word":"„ÄÇ","pinyin":""},{"word":"\\n","pinyin":""}].\n\n{{TEXT}}`,
                explain: `Gi·∫£i th√≠ch n·ªôi dung ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Trung sau b·∫±ng TI·∫æNG VI·ªÜT. \nY√™u c·∫ßu: \n1. Chia theo t·ª´ng c√¢u (g·ªìm ch·ªØ H√°n, Pinyin, Nghƒ©a Vi·ªát). \n2. Ph√¢n t√≠ch ng·ªØ ph√°p v√† t·ª´ v·ª±ng quan tr·ªçng trong m·ªói c√¢u. \n3. N·∫øu ƒëo·∫°n vƒÉn l√† ti√™u ƒë·ªÅ ho·∫∑c r·∫•t ng·∫Øn, h√£y gi·∫£i th√≠ch √Ω nghƒ©a c·ªßa ti√™u ƒë·ªÅ ƒë√≥. \nKH√îNG d√πng ti·∫øng Anh. \nVƒÉn b·∫£n:\n\n{{TEXT}}`,
                translate: `D·ªãch ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Trung sau sang TI·∫æNG VI·ªÜT chu·∫©n. \nCh·ªâ tr·∫£ v·ªÅ n·ªôi dung b·∫£n d·ªãch, kh√¥ng th√™m l·ªùi d·∫´n. \nVƒÉn b·∫£n:\n\n{{TEXT}}`
            };

            // 3. SIDEBAR & INIT
            const sidebar = document.getElementById('settings-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const navLinks = document.querySelectorAll('.menu-link');
            if(openSidebarBtn) {
                openSidebarBtn.addEventListener('click', () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); });
                closeSidebarBtn.addEventListener('click', closeSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);
                navLinks.forEach(link => link.addEventListener('click', closeSidebar));
            }
            function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); }

            // 4. DOM ELEMENTS
            const textDisplay = document.getElementById('text-display');
            const delayInput = document.getElementById('delay-input');
            const chunkSizeInput = document.getElementById('chunk-size-input');
            const urlInput = document.getElementById('url-input');
            const fetchUrlButton = document.getElementById('fetch-url-button');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');
            const textInputArea = document.getElementById('text-input-area');
            const processTextButton = document.getElementById('process-text-button');
            
            // Stats
            const textStatsSection = document.getElementById('text-stats-section');
            const charCountSpan = document.getElementById('char-count');
            const wordCountSpan = document.getElementById('word-count');
            const copyMainTextButton = document.getElementById('copy-main-text-button');

            // Settings & Prompts
            const aiProviderSelect = document.getElementById('ai-provider-select');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyButton = document.getElementById('save-api-key-button');
            const apiKeyGuide = document.getElementById('api-key-guide');
            const apiKeyStatus = document.getElementById('api-key-status');
            const prompts = {
                pinyin: document.getElementById('prompt-pinyin'),
                segment: document.getElementById('prompt-segment'),
                explain: document.getElementById('prompt-explain'),
                translate: document.getElementById('prompt-translate')
            };
            const resetPromptsBtn = document.getElementById('reset-prompts-btn');

            // Media
            const mediaUploadInput = document.getElementById('media-upload');
            const mediaContainer = document.getElementById('media-container');
            const mainVideoPlayer = document.getElementById('main-media-player');
            const mainAudioPlayer = document.getElementById('main-audio-player');
            const mediaFilename = document.getElementById('media-filename');
            const mediaControls = document.getElementById('media-controls');
            const mediaRewindBtn = document.getElementById('media-rewind');
            const mediaForwardBtn = document.getElementById('media-forward');
            const mediaRateSelect = document.getElementById('media-rate');

            // TTS
            const ttsPlayPauseBtn = document.getElementById('tts-play-pause');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playPauseText = document.getElementById('play-pause-text');
            const ttsStopBtn = document.getElementById('tts-stop');
            const ttsProgressContainer = document.getElementById('tts-progress-container');
            const ttsProgressBar = document.getElementById('tts-progress-bar');
            const autoPlayToggle = document.getElementById('auto-play-toggle');

            // Popups
            const lookupModalOverlay = document.getElementById('lookup-modal');
            const modalContentInner = document.getElementById('modal-content-inner');
            const selectedWordModalSpan = document.getElementById('selected-word-modal');
            const googleTranslateResultDiv = document.getElementById('google-translate-result');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');
            const closeLookupModalBtn = document.getElementById('close-lookup-modal');
            const pronounceWordButton = document.getElementById('pronounce-word-button');
            const copyWordButton = document.getElementById('copy-word-button');
            const selectionPopup = document.getElementById('selection-popup');
            const closeSelectionPopupBtn = document.getElementById('close-selection-popup');
            const copySelectionButton = document.getElementById('copy-selection-button');
            const translateSelectionButton = document.getElementById('translate-selection-button');
            const pronounceSelectionButton = document.getElementById('pronounce-selection-button');
            const hanziiSelectionLink = document.getElementById('hanzii-selection-link');
            const selectionTranslateResultDiv = document.getElementById('selection-translate-result');
            const selectionTranslateSpinner = document.getElementById('selection-translate-spinner');
            
            // AI Tools
            const aiCustomInput = document.getElementById('ai-custom-input');

            let currentRawText = '';
            let requestQueue = [];
            let isRequestLoopRunning = false;
            let speechStartIndex = 0;

            // --- 5. LOGIC & TASKS ---
            // Load Prompts immediately
            function loadPrompts() {
                prompts.pinyin.value = localStorage.getItem('promptPinyin') || DEFAULT_PROMPTS.pinyin;
                prompts.segment.value = localStorage.getItem('promptSegment') || DEFAULT_PROMPTS.segment;
                prompts.explain.value = localStorage.getItem('promptExplain') || DEFAULT_PROMPTS.explain;
                prompts.translate.value = localStorage.getItem('promptTranslate') || DEFAULT_PROMPTS.translate;
            }
            loadPrompts();

            // Tasks Registry
            const tasks = {
                pinyin: { active: false, currentIndex: 0, queue: [], container: document.getElementById('pinyin-content'), section: document.getElementById('pinyin-text-section'), processor: processPinyinChunk, stopBtn: document.getElementById('stop-pinyin'), progressDiv: document.getElementById('progress-pinyin') },
                segment: { active: false, currentIndex: 0, queue: [], container: document.getElementById('segmented-content'), section: document.getElementById('segmented-text-section'), processor: processSegmentationChunk, stopBtn: document.getElementById('stop-segment'), progressDiv: document.getElementById('progress-segment') },
                explain: { active: false, currentIndex: 0, queue: [], container: document.getElementById('explanation-content'), section: document.getElementById('explanation-section'), processor: processExplanationChunk, stopBtn: document.getElementById('stop-explain'), progressDiv: document.getElementById('progress-explain') },
                translate: { active: false, currentIndex: 0, queue: [], container: document.getElementById('full-translation-content'), section: document.getElementById('full-translation-section'), processor: processTranslationChunk, stopBtn: document.getElementById('stop-translate'), progressDiv: document.getElementById('progress-translate') }
            };

            async function processRequestQueue() {
                if (isRequestLoopRunning) return;
                isRequestLoopRunning = true;
                while (requestQueue.length > 0) {
                    const job = requestQueue.shift();
                    const task = tasks[job.taskKey];
                    if (!task.active) continue;
                    
                    updateTaskStatus(job.taskKey, "ƒêang x·ª≠ l√Ω...");
                    try {
                        await job.processor(job.chunk, task.container, null, job.index);
                        task.currentIndex++;
                        if (task.active && task.currentIndex < task.queue.length) scheduleNextChunk(job.taskKey);
                        else if (task.currentIndex >= task.queue.length) finishTask(job.taskKey);
                    } catch (error) {
                        console.error(error);
                        task.container.innerHTML += `<p class="text-red-500">L·ªói: ${error.message}</p>`;
                    }
                    const delay = (parseFloat(delayInput.value) || 5) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
                isRequestLoopRunning = false;
            }

            function scheduleNextChunk(taskKey) {
                const task = tasks[taskKey];
                if(!task.active || task.currentIndex >= task.queue.length) return;
                requestQueue.push({ taskKey: taskKey, chunk: task.queue[task.currentIndex], index: task.currentIndex, processor: task.processor });
                updateTaskStatus(taskKey, "ƒêang ƒë·ª£i...");
                processRequestQueue();
            }

            function startTask(taskKey) {
                if(!currentRawText) { showNotification("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n", "error"); return; }
                const task = tasks[taskKey];
                task.section.classList.remove('hidden');
                task.stopBtn.classList.remove('hidden');
                task.progressDiv.style.display = 'block';
                task.active = true;
                
                if(task.queue.length === 0 || task.currentIndex >= task.queue.length) {
                    task.container.innerHTML = '';
                    const size = parseInt(chunkSizeInput.value) || 100;
                    task.queue = chunkText(currentRawText, size);
                    task.currentIndex = 0;
                }
                scheduleNextChunk(taskKey);
            }

            function stopTask(taskKey) {
                tasks[taskKey].active = false;
                tasks[taskKey].stopBtn.classList.add('hidden');
                updateTaskStatus(taskKey, "ƒê√£ d·ª´ng");
            }

            function finishTask(taskKey) {
                tasks[taskKey].active = false;
                tasks[taskKey].stopBtn.classList.add('hidden');
                updateTaskStatus(taskKey, "Ho√†n th√†nh!");
            }

            function updateTaskStatus(taskKey, text) {
                const t = tasks[taskKey];
                const p = Math.round((t.currentIndex / Math.max(t.queue.length, 1)) * 100);
                t.progressDiv.querySelector('.task-progress-bar-fill').style.width = `${p}%`;
                t.progressDiv.querySelector('.task-status-text').innerHTML = `<span>${text}</span><span>${p}%</span>`;
            }

            // --- PROCESSORS ---
            async function processPinyinChunk(chunk, container, _, index) {
                const p = getPrompt('pinyin', chunk);
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "char": { "type": "STRING" }, "pinyin": { "type": "STRING" } } } };
                const res = await callAI(p, "application/json", schema);
                let data = parseAiJson(res);
                data.forEach(item => {
                    const char = (item.char||item.word||'').toString();
                    if(char==='\n') container.appendChild(document.createElement('br'));
                    else if(item.pinyin) {
                        const r = document.createElement('ruby'); r.className='word-clickable'; r.textContent=char;
                        const rt = document.createElement('rt'); rt.textContent=item.pinyin; r.appendChild(rt);
                        r.onclick = (e) => { e.stopPropagation(); openLookupModal(char, e); };
                        container.appendChild(r);
                    } else {
                        const s = document.createElement('span'); s.innerHTML = char.replace(/ /g, '&nbsp;'); container.appendChild(s);
                    }
                });
            }

            async function processSegmentationChunk(chunk, container, _, index) {
                const p = getPrompt('segment', chunk);
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "pinyin": { "type": "STRING" } }, required: ["word", "pinyin"] } };
                const res = await callAI(p, "application/json", schema);
                let data = parseAiJson(res);
                data.forEach(seg => {
                     const word = (seg.word||seg.text||'').toString();
                     if(word==='\n') container.appendChild(document.createElement('br'));
                     else if(word.match(/[\u4e00-\u9fa5]/)) {
                        const r = document.createElement('ruby'); r.className='segmented-word'; r.textContent=word;
                        if(seg.pinyin) { const rt=document.createElement('rt'); rt.textContent=seg.pinyin; r.appendChild(rt); }
                        r.onclick = (e) => { e.stopPropagation(); openLookupModal(word, e); };
                        container.appendChild(r);
                     } else {
                         const s = document.createElement('span'); s.innerHTML = word.replace(/ /g, '&nbsp;'); container.appendChild(s);
                     }
                });
            }

            async function processExplanationChunk(chunk, container, _, index) {
                const p = getPrompt('explain', chunk);
                const res = await callAI(p, "text/plain");
                container.innerHTML += `<h4 class="font-bold text-indigo-700 mb-2 mt-4">ƒêo·∫°n ${index+1}:</h4>` + res.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + '<hr class="my-4">';
            }

            async function processTranslationChunk(chunk, container, _, index) {
                const p = getPrompt('translate', chunk);
                const res = await callAI(p, "text/plain");
                container.innerText += res + '\n\n';
            }

            // --- UTILS & API ---
            function getPrompt(type, text) {
                let t = prompts[type].value;
                if(!t.trim()) t = DEFAULT_PROMPTS[type];
                return t.replace('{{TEXT}}', text);
            }

            function chunkText(text, size) {
                const chunks = []; if (!text) return chunks;
                const parts = text.split(/([„ÄÇÔºÅÔºü\n\r]+)/).filter(Boolean);
                let current = '';
                for(let p of parts) {
                    if(current.length + p.length > size && current.length > 0) { chunks.push(current); current = p; }
                    else current += p;
                }
                if(current) chunks.push(current);
                return chunks.filter(c => c.trim() !== '');
            }

            function parseAiJson(str) {
                try {
                    const json = JSON.parse(str);
                    if(Array.isArray(json)) return json;
                    for(let k in json) if(Array.isArray(json[k])) return json[k];
                    return [json];
                } catch(e) { throw new Error("JSON Parse Error"); }
            }

            function extractJson(text) {
                const s = text.indexOf('{'), sq = text.indexOf('[');
                let start = -1;
                if(s !== -1 && sq !== -1) start = Math.min(s, sq); else if(s!==-1) start=s; else if(sq!==-1) start=sq;
                if(start === -1) return text;
                const e = text.lastIndexOf('}'), eq = text.lastIndexOf(']');
                let end = Math.max(e, eq);
                return text.substring(start, end + 1);
            }

            async function callAI(prompt, mimeType, schema) {
                const key = apiKeyInput.value.trim();
                const provider = aiProviderSelect.value;
                if(!key) throw new Error("Thi·∫øu API Key");
                
                let url, body;
                if(provider === 'gemini') {
                    url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${key}`;
                    body = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: mimeType } };
                    if(schema) body.generationConfig.responseSchema = schema;
                } else {
                    url = 'https://api.deepseek.com/chat/completions';
                    const isJson = mimeType === 'application/json';
                    body = { 
                        model: "deepseek-chat", 
                        messages: [{ role: "system", content: isJson ? "JSON format." : "" }, { role: "user", content: prompt }], 
                        stream: false 
                    };
                    if(isJson) body.response_format = { type: "json_object" };
                }
                
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...(provider==='deepseek' && {'Authorization': `Bearer ${key}`}) }, body: JSON.stringify(body) });
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                
                let txt = provider === 'gemini' ? json.candidates?.[0]?.content?.parts?.[0]?.text : json.choices?.[0]?.message?.content;
                if(!txt) throw new Error("No response");
                if(mimeType === 'application/json') txt = extractJson(txt);
                console.log("AI:", txt);
                return txt;
            }

            // --- EVENT LISTENERS ---
            // Task Buttons
            document.getElementById('pinyin-button').addEventListener('click', () => startTask('pinyin'));
            document.getElementById('segment-text-button').addEventListener('click', () => startTask('segment'));
            document.getElementById('explain-text-button').addEventListener('click', () => startTask('explain'));
            document.getElementById('translate-full-text-button').addEventListener('click', () => startTask('translate'));
            
            // Stop Buttons
            document.getElementById('stop-pinyin').addEventListener('click', () => stopTask('pinyin'));
            document.getElementById('stop-segment').addEventListener('click', () => stopTask('segment'));
            document.getElementById('stop-explain').addEventListener('click', () => stopTask('explain'));
            document.getElementById('stop-translate').addEventListener('click', () => stopTask('translate'));

            // Toggle Buttons
            document.querySelectorAll('.toggle-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    let content;
                    if(targetId) content = document.getElementById(targetId);
                    else content = btn.closest('.section-header').nextElementSibling;
                    
                    if(content) {
                        content.classList.toggle('hidden');
                        btn.textContent = content.classList.contains('hidden') ? 'Hi·ªÉn th·ªã' : 'Thu g·ªçn';
                    }
                });
            });
            
            // Copy Buttons (FIXED)
            document.querySelectorAll('.copy-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    if(targetId) {
                         const contentDiv = document.getElementById(targetId);
                         copyHtmlToClipboard(contentDiv);
                    } else {
                        const content = btn.closest('.section-header').nextElementSibling;
                        copyHtmlToClipboard(content);
                    }
                });
            });

            // Settings Buttons
            Object.values(prompts).forEach((el, i) => {
                const keys = ['promptPinyin', 'promptSegment', 'promptExplain', 'promptTranslate'];
                el.addEventListener('change', () => localStorage.setItem(keys[i], el.value));
            });
            resetPromptsBtn.addEventListener('click', () => { 
                if(confirm("Kh√¥i ph·ª•c prompt g·ªëc?")) { 
                    localStorage.removeItem('promptPinyin'); localStorage.removeItem('promptSegment');
                    localStorage.removeItem('promptExplain'); localStorage.removeItem('promptTranslate');
                    loadPrompts();
                } 
            });
            
            function updateApiKeyGuide() { apiKeyGuide.innerHTML = aiProviderSelect.value === 'gemini' ? 'L·∫•y API t·∫°i Google AI Studio' : 'L·∫•y API t·∫°i DeepSeek'; }
            aiProviderSelect.addEventListener('change', () => { updateApiKeyGuide(); localStorage.setItem('dichiAiProvider', aiProviderSelect.value); });
            saveApiKeyButton.addEventListener('click', () => { localStorage.setItem('dichiApiKey', apiKeyInput.value); apiKeyStatus.textContent = "ƒê√£ l∆∞u!"; setTimeout(() => apiKeyStatus.textContent = "", 2000); });
            chunkSizeInput.addEventListener('change', () => localStorage.setItem('dichiChunkSize', chunkSizeInput.value));

            // File Upload
            fileUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                e.target.value = ''; fileNameSpan.textContent = file.name;
                if(file.name.toLowerCase().endsWith('.docx')) {
                    if(window.mammoth) window.mammoth.convertToHtml({arrayBuffer: file}).then(r => processNewContent(r.value, true)).catch(err => alert(err));
                    else { const reader = new FileReader(); reader.onload = ev => window.mammoth.convertToHtml({arrayBuffer: ev.target.result}).then(r => processNewContent(r.value, true)); reader.readAsArrayBuffer(file); }
                } else {
                    const reader = new FileReader(); reader.onload = ev => processNewContent(ev.target.result); reader.readAsText(file);
                }
            });
            
            processTextButton.addEventListener('click', () => { if(textInputArea.value) processNewContent(textInputArea.value); });
            
            fetchUrlButton.addEventListener('click', async () => {
                if(!urlInput.value) return;
                fetchUrlButton.disabled = true; textDisplay.textContent = "ƒêang t·∫£i...";
                try {
                    const res = await fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(urlInput.value)}`);
                    const html = await res.text();
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const content = (doc.querySelector('article') || doc.querySelector('main') || doc.body).innerText;
                    processNewContent(content);
                } catch(e) { textDisplay.textContent = "L·ªói t·∫£i URL"; }
                fetchUrlButton.disabled = false;
            });

            function processNewContent(content, isHtml=false) {
                speechSynthesis.cancel();
                Object.keys(tasks).forEach(k => { tasks[k].queue=[]; tasks[k].active=false; tasks[k].section.classList.add('hidden'); tasks[k].container.innerHTML=''; });
                requestQueue.length = 0;
                
                if(isHtml) { textDisplay.innerHTML = content; currentRawText = textDisplay.innerText; }
                else { textDisplay.textContent = content; currentRawText = content; }
                
                addClickableSpansTo(textDisplay, currentRawText);
                
                document.getElementById('text-stats-section').classList.remove('hidden');
                document.getElementById('char-count').textContent = currentRawText.length;
                document.getElementById('word-count').textContent = currentRawText.split(/\s+/).length;
            }

            function addClickableSpansTo(el, text) {
                el.innerHTML = '';
                text.split(/([\u4e00-\u9fa5]+)/).forEach(part => {
                    if(part.match(/[\u4e00-\u9fa5]/)) {
                        part.split('').forEach(char => {
                             const s = document.createElement('span'); s.textContent = char; s.className = 'word-clickable';
                             s.onclick = (e) => { e.stopPropagation(); openLookupModal(char, e); };
                             el.appendChild(s);
                        });
                    } else el.appendChild(document.createTextNode(part));
                });
            }

            // AI Tools
            const aiSpinner = document.getElementById('loading-spinner');
            document.getElementById('ai-generate-sentence-button').addEventListener('click', async () => {
                const w = document.getElementById('ai-custom-input').value; if(!w) return;
                aiSpinner.style.display = 'block'; document.getElementById('ai-sentence-results-section').classList.remove('hidden');
                try {
                    // FIX AI PROMPT (Vietnamese)
                    const prompt = `T·∫°o 5 c√¢u v√≠ d·ª• ti·∫øng Trung cho t·ª´ "${w}". \nQuan tr·ªçng: Meaning ph·∫£i l√† TI·∫æNG VI·ªÜT. \nJSON: {"items": [{"sentence": "...", "pinyin": "...", "meaning": "..."}]}`;
                    const res = await callAI(prompt, "application/json");
                    const data = parseAiJson(res);
                    document.getElementById('ai-sentence-content').innerHTML = data.map(i => `<div class="mb-2"><b>${i.sentence}</b><br><span class="text-gray-500 text-sm">${i.pinyin}</span><br><span class="text-blue-600 text-sm">${i.meaning}</span></div>`).join('');
                } catch(e) { alert(e.message); } finally { aiSpinner.style.display = 'none'; }
            });

            document.getElementById('ai-generate-related-words-button').addEventListener('click', async () => {
                 const w = document.getElementById('ai-custom-input').value; if(!w) return;
                aiSpinner.style.display = 'block'; document.getElementById('ai-related-words-results-section').classList.remove('hidden');
                try {
                     // FIX AI PROMPT (Vietnamese)
                    const prompt = `T√¨m 10 t·ª´ li√™n quan ƒë·∫øn "${w}". \nQuan tr·ªçng: Meaning ph·∫£i l√† TI·∫æNG VI·ªÜT. \nJSON: {"items": [{"word": "...", "pinyin": "...", "meaning": "..."}]}`;
                    const res = await callAI(prompt, "application/json");
                    const data = parseAiJson(res);
                    document.getElementById('ai-related-words-content').innerHTML = `<div class="grid grid-cols-2 gap-2">` + data.map(i => `<div class="p-2 border rounded cursor-pointer hover:bg-blue-50" onclick="document.getElementById('ai-custom-input').value='${i.word}'"><b>${i.word}</b><br><span class="text-xs">${i.pinyin}</span><br><span class="text-xs text-gray-600">${i.meaning}</span></div>`).join('') + `</div>`;
                } catch(e) { alert(e.message); } finally { aiSpinner.style.display = 'none'; }
            });

            // Lookup Modal
            async function openLookupModal(word, e) {
                selectedWordModalSpan.textContent = word; googleTranslateResultDiv.innerHTML = ''; lookupModalOverlay.style.display = 'block';
                
                const enc = encodeURIComponent(word);
                document.getElementById('hanzii-link').href = `https://hanzii.net/search/word/${enc}`;
                document.getElementById('mdbg-link').href = `https://www.mdbg.net/chinese/dictionary?wdqb=${enc}`;
                document.getElementById('youglish-link').href = `https://youglish.com/pronounce/${enc}/chinese`;
                document.getElementById('vtudien-link').href = `https://vtudien.com/trung-viet/dictionary/nghia-cua-tu-${enc}`;
                
                const modalWidth = modalContentInner.offsetWidth;
                const modalHeight = modalContentInner.offsetHeight;
                let left = e.clientX; let top = e.clientY;
                if (left + modalWidth > window.innerWidth) left = window.innerWidth - modalWidth - 20;
                if (top + modalHeight > window.innerHeight) top = window.innerHeight - modalHeight - 20;
                
                modalContentInner.style.top = `${top}px`; modalContentInner.style.left = `${left}px`;
                
                pronounceWordButton.onclick = () => speakWord(word);
                copyWordButton.onclick = () => copyToClipboard(word);
                
                // FIX: Auto fill AI input & Speak
                if(aiCustomInput) aiCustomInput.value = word;
                if(autoPlayToggle && autoPlayToggle.checked) speakWord(word);

                try {
                    const res = await getTranslation(word);
                    googleTranslateResultDiv.innerHTML = `<b>${res.pinyin}</b><br>${res.meaning}`;
                } catch(e) { googleTranslateResultDiv.innerHTML = 'L·ªói d·ªãch'; }
            }
            
            async function getTranslation(word) {
                 const prompt = `D·ªãch "${word}" sang ti·∫øng Vi·ªát. JSON: {"pinyin": "...", "meaning": "..."}`;
                 const res = await callAI(prompt, "application/json");
                 return JSON.parse(res);
            }
            
            closeLookupModalBtn.addEventListener('click', () => lookupModalOverlay.style.display = 'none');
            closeSelectionPopupBtn.addEventListener('click', () => selectionPopup.classList.add('hidden'));

            // Selection Popup
            document.addEventListener('mouseup', (e) => {
                setTimeout(() => {
                    const s = window.getSelection(); if (!s || s.isCollapsed) return;
                    const t = s.toString().trim(); if (!t || selectionPopup.contains(e.target) || modalContentInner.contains(e.target) || e.target.closest('.word-clickable')) return;
                    lookupModalOverlay.style.display = 'none'; selectionPopup.classList.remove('hidden');
                    
                    const r = s.getRangeAt(0).getBoundingClientRect();
                    let top = r.bottom + window.scrollY + 5; let left = r.left + window.scrollX;
                    selectionPopup.style.top = `${top}px`; selectionPopup.style.left = `${left}px`;
                    
                    // FIX: Update AI input & Auto speak
                    if(aiCustomInput) aiCustomInput.value = t;
                    if(autoPlayToggle && autoPlayToggle.checked) speakWord(t);

                    copySelectionButton.onclick = () => { copyToClipboard(t); selectionPopup.classList.add('hidden'); };
                    translateSelectionButton.onclick = async () => { 
                        selectionTranslateResultDiv.classList.add('hidden'); selectionTranslateSpinner.style.display = 'block'; 
                        const r = await getTranslation(t); 
                        selectionTranslateSpinner.style.display = 'none'; 
                        if(r.meaning!=='Kh√¥ng th·ªÉ d·ªãch.') { selectionTranslateResultDiv.innerHTML = `<strong>D·ªãch:</strong> ${r.pinyin} - ${r.meaning}`; selectionTranslateResultDiv.classList.remove('hidden'); } 
                    };
                    pronounceSelectionButton.onclick = () => speakWord(t); hanziiSelectionLink.href = `https://hanzii.net/search/word/${encodeURIComponent(t)}`;
                }, 0);
            });

            // Media
            mediaUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                const url = URL.createObjectURL(file);
                // Fix: Properly stop previous media
                if(activeMediaPlayer) { activeMediaPlayer.pause(); activeMediaPlayer.src = ""; }
                
                document.getElementById('media-container').classList.remove('hidden');
                document.getElementById('media-filename').textContent = file.name;
                const v = document.getElementById('main-media-player');
                const a = document.getElementById('main-audio-player');
                
                if(file.type.startsWith('video')) { 
                    v.src = url; v.style.display = 'block'; a.style.display = 'none'; activeMediaPlayer = v; 
                } else { 
                    a.src = url; a.style.display = 'block'; v.style.display = 'none'; activeMediaPlayer = a; 
                }
                
                // Fix: Enable controls
                document.getElementById('media-controls').classList.remove('opacity-50', 'pointer-events-none');
                
                activeMediaPlayer.onplay = () => { speechSynthesis.cancel(); };
                // Optional: Auto play
                // activeMediaPlayer.play(); 
            });
            mediaRewindBtn.addEventListener('click', () => { if(activeMediaPlayer) activeMediaPlayer.currentTime -= 10; });
            mediaForwardBtn.addEventListener('click', () => { if(activeMediaPlayer) activeMediaPlayer.currentTime += 10; });
            mediaRateSelect.addEventListener('change', (e) => { if(activeMediaPlayer) activeMediaPlayer.playbackRate = parseFloat(e.target.value); });

            // Load Config
            if(localStorage.getItem('dichiApiKey')) apiKeyInput.value = localStorage.getItem('dichiApiKey');
            if(localStorage.getItem('dichiAiProvider')) aiProviderSelect.value = localStorage.getItem('dichiAiProvider');
            if(localStorage.getItem('dichiChunkSize')) chunkSizeInput.value = localStorage.getItem('dichiChunkSize');
            updateApiKeyGuide();
        }
        window.addEventListener('load', mainApp);
    </script>
</body>
</html>
